{% assign image_path = include.path | default: include.src %}
{% assign alt = include.alt | default: "Image" %}
{% assign sizes = include.sizes | default: "(max-width: 800px) 100vw, 800px" %}
{% assign widths = include.widths | default: "320,480,768,1024,1200" | split: "," %}
{% assign lazy = include.lazy | default: "true" %}
{% assign is_featured = include.featured | default: "false" %}

{% comment %}
Fix for handling hyphenated filenames - convert hyphens to underscores
in the filename while preserving the path and ensuring absolute paths
{% endcomment %}

{% unless image_path contains "://" %}
  {% if image_path contains "/" %}
    {% assign first_char = image_path | slice: 0 %}
    {% unless first_char == "/" %}
      {% assign image_path = "/" | append: image_path %}
    {% endunless %}
    
    {% assign path_parts = image_path | split: "/" %}
    {% assign filename = path_parts | last %}
    {% assign filename_with_underscores = filename | replace: "-", "_" %}
    {% assign path_parts_size = path_parts | size | minus: 1 %}
    {% assign directory_path = "" %}
    {% for i in (0..path_parts_size) %}
      {% if i < path_parts_size %}
        {% if directory_path == "" %}
          {% assign directory_path = path_parts[i] %}
        {% else %}
          {% assign directory_path = directory_path | append: "/" | append: path_parts[i] %}
        {% endif %}
      {% endif %}
    {% endfor %}
    {% if directory_path != "" %}
      {% assign base_filename = directory_path | append: "/" | append: filename_with_underscores | split: '.' | first %}
    {% else %}
      {% assign base_filename = filename_with_underscores | split: '.' | first %}
    {% endif %}
  {% else %}
    {% assign base_filename = image_path | replace: "-", "_" | split: '.' | first %}
  {% endif %}
{% else %}
  {% assign base_filename = image_path %}
{% endunless %}

<picture class="{{ include.class }}">
  <!-- AVIF Format -->
  <source
    type="image/avif"
    srcset="
      {% for width in widths %}
        {{ base_filename }}_{{ width }}.avif {{ width }}w{% unless forloop.last %},{% endunless %}
      {% endfor %}
    "
    sizes="{{ sizes }}">
    
  <!-- WebP Format -->
  <source
    type="image/webp"
    srcset="
      {% for width in widths %}
        {{ base_filename }}_{{ width }}.webp {{ width }}w{% unless forloop.last %},{% endunless %}
      {% endfor %}
    "
    sizes="{{ sizes }}">
    
  <!-- Original Format (Fallback) -->
  <img
    src="{{ base_filename }}_320.png"
    srcset="
      {% for width in widths %}
        {{ base_filename }}_{{ width }}.png {{ width }}w{% unless forloop.last %},{% endunless %}
      {% endfor %}
    "
    alt="{{ alt }}"
    {% if lazy == "true" and is_featured == "false" %}loading="lazy" decoding="async"{% else %}loading="eager" decoding="sync"{% endif %}
    {% if include.width %}width="{{ include.width }}"{% endif %}
    {% if include.height %}height="{{ include.height }}"{% endif %}
    class="{{ include.img_class }}">
</picture> 
